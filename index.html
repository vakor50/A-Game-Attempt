<!DOCTYPE html>
<html>
<head>
	<title>A Game Attempt</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<style type="text/css">
		
	</style>
</head>
<body>
	<canvas id="canvas" width="400" height="300">
		This text is displayed if your browser does not support HTML5 Canvas.
	</canvas>
	<div class="container">
		<div class="row">
			<span id="output"></span>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script type="text/javascript">
		var canvasWidth = 480;
		var canvasHeight = 270;
		var pieceSize = 30;
		var myGamePiece;

		var board = new Array(canvasHeight / pieceSize);
		function clearBoard () {
			board = new Array(canvasHeight / pieceSize);

			for (var i = 0; i < board.length; i += 1) {
				board[i] = new Array(canvasWidth / pieceSize)

				for (var j = 0; j < board[i].length; j += 1) {
					board[i][j] = 0;
				}
			}

			addBoardBorder()
		}

		function addBoardBorder() {
			for (var i = 0; i < board.length; i += 1) {
				for (var j = 0; j < board[i].length; j += 1) {
					if (i == 0 || i == board.length - 1) {
						board[i][j] = 3
					} else if (j == 0 || j == board[i].length - 1) {
						board[i][j] = 3
					}
				}
			}
		}
		
		function logBoard () {
			var str = ""
			for (var i = 0; i < board.length; i += 1) {
				for (var j = 0; j < board[i].length; j += 1) {
					var temp = '';
					switch (board[i][j]) {
						case 0:
							temp = '.';
							break;
						case 1:
							temp = '@';
							break;
						case 2:
							temp = 'O';
							break;
						case 3:
							temp = '#';
							break;
					}
					str += temp + " ";
				}
				str += "\n"
			}
			console.log(str)
		}

		function setPiece(x, y, type) {
			switch (type) {
				case "player":
					board[y][x] = 1
					break;
				case "monster":
					board[y][x] = 2
					break;
				default:
					board[y][x] = 0
					break;
			}
		}

		class Player {
			constructor() {
				this.x = 1;
				this.y = 1;
			}
		}

		function moveTowards(source, target) {
			var end = source;
			if (source[0] < target[0] && isOpenPos(source[0]+1, source[1])) {
				end[0] += 1;
			} else if (source[0] > target[0] && isOpenPos(source[0]-1, source[1])) {
				end[0] -= 1;
			} else if (source[1] < target[1] && isOpenPos(source[0], source[1]+1)) {
				end[1] += 1;
			} else if (source[1] > target[1] && isOpenPos(source[0], source[1]-1)) {
				end[1] -= 1;
			} else {

			}

			return end;
		}

		function moveMonster(creature) {
			var search = searchAround(4, creature);
			var hasMoved = false;
			for (var i = 0; i < search.length; i++) {
				if (search[i].type == 1) {
					var end = moveTowards([creature.x, creature.y], [search[i].x,search[i].y])
					creature.x = end[0];
					creature.y = end[1];
					hasMoved = true;
					return;
				}
			}
			if (!hasMoved) {
				// if no target, move randomly
				var end = [creature.x, creature.y]
				var upDownOrLeftRight = Math.floor( (Math.random() * 2) + 1)
				if (upDownOrLeftRight == 1) {
					var upDown = Math.floor( (Math.random() * 2) + 1)
					if (upDown == 1 && isOpenPos(end[0], end[1]+1)) {
						end[1] += 1
					} else if (isOpenPos(end[0], end[1]-1)) {
						end[1] -= 1;
					}
				} else {
					var leftRight = Math.floor( (Math.random() * 2) + 1)
					if (leftRight == 1 && isOpenPos(end[0]+1, end[1])) {
						end[0] += 1
					} else if (isOpenPos(end[0]-1, end[1])) {
						end[0] -= 1;
					}
				}

				creature.x = end[0];
				creature.y = end[1];
			}
		}

		function searchAround(radius, creature) {
			var nearby = [];
			for (var i = -radius; i < radius; i++) {
				for (var j = -radius; j < radius; j++) {
					console.log((creature.x+i) + " , " + (creature.y+j))
					if (isPlayer(creature.x+i,creature.y+j)) {
						nearby.push({
							"x": creature.x+i, 
							"y": creature.y+j,
							"type": board[creature.y+i][creature.x+j]
						})
					}
				}
			}
			return nearby;
		}


		var p = new Player();
		var m = new Player();

		function setBoard() {
			clearBoard();
			setPiece(p.x, p.y, "player")
			moveMonster(m)
			setPiece(m.x, m.y, "monster")
			logBoard();

		}

		function initBoard() {
			clearBoard();
			setPiece(p.x, p.y, "player")
			m.x = Math.floor( Math.random() * ((canvasWidth / pieceSize)/2 - 1) + (canvasWidth / pieceSize)/2)
			m.y = Math.floor( Math.random() * ((canvasHeight / pieceSize) - 2) + 1)
			console.log(m.x)
			console.log(m.y)
			setPiece(m.x, m.y, "monster")
			logBoard();
		}

		function isPlayer(x, y) {
			console.log(x)
			console.log(y)
			if (x > 0 && x < canvasWidth / pieceSize) {
				return false;
			}
			if (y > 0 && y < canvasHeight / pieceSize) {
				return false;
			}
			// console.log(board)
			switch(board[y][x]) {
				case 3: // Wall
					return false;
				case 2: // Monster
					return false;
				case 1: // Player
					return true;
				case 0: // Empty
					return true;
				default:
					return false;
			}
		}

		function isOpenPos(x, y) {
			if (x < 0 && x >= canvasWidth / pieceSize) {
				return false;
			}
			if (y < 0 && y >= canvasHeight / pieceSize) {
				return false;
			}
			switch(board[y][x]) {
				case 3: // Wall
					return false;
				case 2: // Monster
					return false;
				case 1: // Player
					return false;
				case 0: // Empty
					return true;
			}
		}

		function displayBoard() {
			initBoard();

			$('body').keyup(function( event ) {
				// 
			}).keydown(function( event ) {
				if ( event.which == 87 ) {
					// up
					if (isOpenPos(p.x, p.y-1)) {
						p.y -= 1
					}
					console.log("up")
					setBoard();
				} else if ( event.which == 83 ) {
					// down
					if (isOpenPos(p.x, p.y+1)) {
						p.y += 1
					}
					console.log("down")
					setBoard();
				} else if ( event.which == 65 ) {
					// left
					if (isOpenPos(p.x-1, p.y)) {
						p.x -= 1
					}
					console.log("left")
					setBoard();
				} else if ( event.which == 68 ) {
					// right
					if (isOpenPos(p.x+1, p.y)) {
						p.x += 1
					}
					console.log("right")
					setBoard();
				}
			});
		}

		var myGameArea = {
			canvas : document.getElementById("canvas"),
			start : function() {
				this.canvas.width = canvasWidth;
				this.canvas.height = canvasHeight;
				this.context = this.canvas.getContext("2d");
				document.body.insertBefore(this.canvas, document.body.childNodes[0]);
				// this.interval = setInterval(updateGameArea, 20);
				updateGameArea();
			},
			clear : function() {
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
				for (var i = 0; i < canvasWidth + pieceSize; i += pieceSize) {
					this.context.beginPath();
					this.context.moveTo(i,0);
					this.context.lineTo(i,canvasHeight);
					this.context.stroke();
				}
				for (var j = 0; j < canvasHeight + pieceSize; j += pieceSize) {
					this.context.beginPath();
					this.context.moveTo(0,j);
					this.context.lineTo(canvasWidth,j);
					this.context.stroke();
				}
			}
		}

		function startGame() {
			myGamePiece = new component(pieceSize, pieceSize, "red", 0, 0);
			myGameArea.start();
		}

		function component(width, height, color, x, y) {
			this.width = width;
			this.height = height;
			this.speedX = 0;
			this.speedY = 0;
			this.x = x;
			this.y = y;	
			this.update = function() {
				ctx = myGameArea.context;
				ctx.fillStyle = color;
				ctx.fillRect(this.x, this.y, this.width, this.height);
			}
			this.newPos = function() {
				var endX = this.x + this.speedX,
					endY = this.y + this.speedY;
				if (endX > -1*this.width && endX < canvasWidth) {
					this.x += this.speedX;
				}
				if (endY > -1*this.height && endY < canvasHeight) {
					this.y += this.speedY;
				}
			}
		}

		function updateGameArea() {
			myGameArea.clear();
			myGamePiece.newPos();
			myGamePiece.update();
		}

		function moveup() {
			myGamePiece.speedX = 0;
			myGamePiece.speedY = -30; 
		}

		function movedown() {
			myGamePiece.speedX = 0;
			myGamePiece.speedY = 30;
		}

		function moveleft() {
			myGamePiece.speedX = -30;
			myGamePiece.speedY = 0;
		}

		function moveright() {
			myGamePiece.speedX = 30;
			myGamePiece.speedY = 0;
		}
		$(document).ready(function () {
			displayBoard();
			startGame();

			var xTriggered = 0
			$('body').keyup(function( event ) {
				xTriggered++;
				var msg = "Handler for .keyup() called " + xTriggered + " time(s).";
				// console.log( msg, "html" );
				// console.log( event );
			}).keydown(function( event ) {
				if ( event.which == 87 ) {
					moveup()
					updateGameArea()
				} else if ( event.which == 83 ) {
					movedown()
					updateGameArea()
				} else if ( event.which == 65 ) {
					moveleft()
					updateGameArea()
				} else if ( event.which == 68 ) {
					moveright()
					updateGameArea()
				}
			});
		});
	</script>
</body>
</html>